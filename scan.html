<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POC Scanner MÃ©dicament</title>

<style>
body {
  margin:0;
  background:black;
  color:white;
  font-family:system-ui, -apple-system, sans-serif;
}

video {
  width:100vw;
  height:100vh;
  object-fit:cover;
}

.overlay {
  position:fixed;
  top:50%;
  left:50%;
  width:70vw;
  height:40vw;
  max-height:40vh;
  border:2px solid #00ff99;
  transform:translate(-50%,-50%);
  pointer-events:none;
}

.result {
  position:fixed;
  bottom:0;
  width:100%;
  padding:12px;
  background:rgba(0,0,0,0.7);
  text-align:center;
  font-size:16px;
}

.start {
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

button {
  font-size:18px;
  padding:16px 24px;
  border-radius:12px;
  border:none;
  background:#00ff99;
  color:black;
}

/* zone log */
#log {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  max-height:30vh;
  overflow:auto;
  background:#111;
  color:#0f0;
  font-size:12px;
  padding:4px;
  z-index:9999;
}
</style>
</head>

<body>

<div id="log"></div>

<div class="start" id="startScreen">
  <button id="startBtn">ðŸ“· DÃ©marrer le scan</button>
</div>

<video id="video" playsinline></video>
<canvas id="canvas" hidden></canvas>

<div class="overlay"></div>
<div class="result" id="result">Aligne le code dans le cadre</div>

<script src="https://unpkg.com/@zxing/browser@latest"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const resultBox = document.getElementById("result");
const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");
const logDiv = document.getElementById("log");

let stream = null;
let reader = null;
let decoding = false;

let lastValue = null;
let hits = 0;

// fonction log sur page
function log(msg) {
  console.log(msg);
  logDiv.innerHTML += msg + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

// âš¡ DÃ©marrage camÃ©ra arriÃ¨re
async function startCamera() {
  try {
    log("Tentative d'accÃ¨s camÃ©raâ€¦");
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal:1280 },
        height: { ideal:720 }
      }
    });

    video.srcObject = stream;
    await video.play();
    log("CamÃ©ra dÃ©marrÃ©e âœ…");
  } catch(e) {
    log("Erreur camÃ©ra : " + e.name + " / " + e.message);
  }
}

function stopCamera() {
  if (!stream) return;
  stream.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  stream = null;
  log("CamÃ©ra arrÃªtÃ©e");
}

// âœ… Validation multi-frame
function validate(value) {
  if (value === lastValue) {
    hits++;
    if (hits >= 2) {
      resultBox.textContent = "âœ… " + value;
      log("Code dÃ©tectÃ© : " + value);
      stopCamera();
    }
  } else {
    lastValue = value;
    hits = 1;
  }
}

// ðŸ” Loop de scan
async function scanLoop() {
  if (!stream || decoding) {
    requestAnimationFrame(scanLoop);
    return;
  }

  decoding = true;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");

  const rw = canvas.width * 0.7;
  const rh = canvas.height * 0.7;
  const rx = (canvas.width - rw)/2;
  const ry = (canvas.height - rh)/2;

  ctx.drawImage(video, rx, ry, rw, rh, 0, 0, canvas.width, canvas.height);

  try {
    const result = await reader.decodeFromCanvas(canvas);
    validate(result.text);
  } catch(e) {
    // normal si rien dÃ©tectÃ©
  } finally {
    decoding = false;
  }

  setTimeout(()=>requestAnimationFrame(scanLoop), 350);
}

// âš¡ DÃ©marrage complet aprÃ¨s clic
async function start() {
  log("Start clic dÃ©tectÃ© !");
  reader = new ZXing.BrowserMultiFormatReader({
    formats:[
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.DATA_MATRIX
    ],
    tryHarder:true
  });

  await startCamera();

  // âš¡ DÃ©lai iOS pour stabiliser la vidÃ©o
  await new Promise(r => setTimeout(r, 500));

  startScreen.style.display = "none";
  scanLoop();
}

startBtn.addEventListener("click", start);
window.addEventListener("beforeunload", stopCamera);
</script>

</body>
</html>
