<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Medic Scan Frontend</title>
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #image-container { max-width: 400px; max-height: 400px; margin-bottom: 10px; }
    img { max-width: 100%; }
    button { margin: 5px 0; padding: 10px; font-size: 16px; }
    #output { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h1>Medic Scan Frontend</h1>

<input type="file" id="fileInput" accept="image/*">
<div id="image-container">
  <img id="image" style="display:none;">
</div>
<button id="decodeBtn" disabled>Décoder DataMatrix</button>

<div id="output"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let cropper;
const imageEl = document.getElementById("image");
const fileInput = document.getElementById("fileInput");
const decodeBtn = document.getElementById("decodeBtn");
const output = document.getElementById("output");

// 1️⃣ Charger l'image et initialiser le cropper
fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  imageEl.src = url;
  imageEl.style.display = "block";

  if (cropper) cropper.destroy();
  cropper = new Cropper(imageEl, {
    aspectRatio: 1,
    viewMode: 1,
  });

  decodeBtn.disabled = false;
});

// 2️⃣ Envoyer l'image recadrée au backend
decodeBtn.addEventListener("click", async () => {
  if (!cropper) return;

  decodeBtn.disabled = true;
  output.textContent = "Envoi en cours…";

  cropper.getCroppedCanvas().toBlob(async (blob) => {
    console.log("Blob ready:", blob);
    const formData = new FormData();
    formData.append("image", blob, "crop.png");

    // Vérifier ce qui est envoyé
    for (let [key, value] of formData.entries()) {
      console.log(key, value);
    }

    try {
      const response = await fetch("https://olivierca.pythonanywhere.com/decode", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      console.log("Backend response:", data);

      if (data.error) {
        output.textContent = "Erreur: " + data.error;
      } else if (!data.found) {
        output.textContent = "Aucun code DataMatrix trouvé.";
      } else {
        output.textContent = "Code(s) détecté(s):\n" + data.codes.join("\n");
      }

    } catch (err) {
      console.error(err);
      output.textContent = "Erreur réseau: " + err;
    } finally {
      decodeBtn.disabled = false;
    }
  }, "image/png");
});
</script>

</body>
</html>
