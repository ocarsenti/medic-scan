<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medic Scan</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 1rem; text-align: center; background: #f5f5f5; }
  h1 { margin-bottom: 1rem; }
  #image { max-width: 100%; display: none; margin-bottom: 1rem; }
  #cropBtn, #fileInput { margin: 0.5rem 0; }
  #result { margin-top: 1rem; padding: 0.5rem; background: #fff; border-radius: 8px; min-height: 50px; }
</style>
<link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
</head>
<body>
<h1>Medic Scan</h1>
<input type="file" id="fileInput" accept="image/*" capture="environment">
<br>
<img id="image">
<br>
<button id="cropBtn" style="display:none;">Décoder DataMatrix</button>
<div id="result"></div>

<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
let cropper;
const image = document.getElementById('image');
const input = document.getElementById('fileInput');
const cropBtn = document.getElementById('cropBtn');
const resultDiv = document.getElementById('result');

input.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  image.onload = () => {
    if (cropper) cropper.destroy();
    cropper = new Cropper(image, {
      aspectRatio: 1,
      viewMode: 1,
      autoCropArea: 0.7, // recadrage automatique 70% du centre
    });
    cropBtn.style.display = 'inline-block';
  };
  image.src = url;
  image.style.display = 'block';
  resultDiv.textContent = '';
});

cropBtn.addEventListener('click', () => {
  if (!cropper) return alert("Chargez d'abord une image");

  cropper.getCroppedCanvas().toBlob(async (blob) => {
    if (!blob) {
      resultDiv.textContent = "Erreur : impossible de récupérer la zone recadrée";
      return;
    }

    const formData = new FormData();
    formData.append("image", blob, "crop.png");

    resultDiv.textContent = "Décodage en cours…";

    try {
      const res = await fetch("https://olivierca.pythonanywhere.com/decode", {
        method: "POST",
        body: formData
      });
      
      if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      const data = await res.json();

      if (data.found) {
        resultDiv.innerHTML = `<strong>Codes décodés :</strong><br>${data.codes.join('<br>')}`;
      } else {
        resultDiv.textContent = "Aucun DataMatrix trouvé";
      }
    } catch(err) {
      resultDiv.textContent = "Erreur lors du décodage : " + err.message;
    }
  }, "image/png");
});
</script>
</body>
</html>
