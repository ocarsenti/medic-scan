<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medic Scan</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
  #image { max-width: 100%; margin-top: 20px; }
  #result { margin-top: 20px; font-size: 1.2em; }
  button { padding: 10px 20px; font-size: 1em; margin-top: 10px; }
</style>
</head>
<body>

<h1>Medic Scan</h1>
<input type="file" id="fileInput" accept="image/*" capture="environment">
<img id="image" style="display:none;">
<br>
<button id="cropBtn" style="display:none;">Décoder DataMatrix</button>

<div id="result"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let cropper;
const image = document.getElementById('image');
const input = document.getElementById('fileInput');
const cropBtn = document.getElementById('cropBtn');
const resultDiv = document.getElementById('result');

input.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  image.src = URL.createObjectURL(file);
  image.style.display = 'block';
  cropBtn.style.display = 'inline-block';
  
  if(cropper) cropper.destroy();
  cropper = new Cropper(image, {
    aspectRatio: 1, // carré pour DataMatrix
    viewMode: 1,
  });
});

cropBtn.addEventListener('click', () => {
  if (!cropper) return alert("Chargez d'abord une image");
  
  cropper.getCroppedCanvas().toBlob(async (blob) => {
    const formData = new FormData();
    formData.append("image", blob, "crop.png");

    resultDiv.textContent = "Décodage en cours…";

    try {
      const res = await fetch("https://olivierca.pythonanywhere.com/decode", {
        method: "POST",
        body: formData
      });
      
      const data = await res.json();
      if(data.found){
        resultDiv.innerHTML = `<strong>Codes décodés :</strong><br>${data.codes.join('<br>')}`;
      } else {
        resultDiv.textContent = "Aucun DataMatrix trouvé";
      }
    } catch(err) {
      resultDiv.textContent = "Erreur : " + err.message;
    }
  });
});
</script>

</body>
</html>
